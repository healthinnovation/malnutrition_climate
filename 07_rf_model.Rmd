---
title: "Modelo predictivo de desnutrición aguda a partir de factores medioambientales"
author: "Luis Revilla"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document: 
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Librerías

Selección de todas las librerías para modelar y entrenar, desde preprocesamiento hasta validación cruzada y optimización de hiperparámetros

```{r libraries, results = FALSE}
library(tidymodels)
library(haven)
library(magrittr)
library(fs)
library(readr)
library(dplyr)
library(dials)
library(corrplot)
library(ggplot2)
library(yardstick)
library(randomForest)
library(DiagrammeR)
```

## Carga de datasets

Tenemos 5 datasets (1 por año)

```{r datasets, results=FALSE}
# Cargar la función

source("load_data.R")
dataset <- load_data()

malnutrition_14 <- dataset$malnutrition_14
malnutrition_15 <- dataset$malnutrition_15
malnutrition_14 <- dataset$malnutrition_14
malnutrition_16 <- dataset$malnutrition_16
malnutrition_17 <- dataset$malnutrition_17
malnutrition_18 <- dataset$malnutrition_18
malnutrition_19 <- dataset$malnutrition_19
```

## Analisis Exploratorio de la Data

### Correlación

En primer lugar, verificamos cómo se comportan las variables unas con otras, 
para seleccionar aquellas que no tengan tan alta correlación entre sí,
debido a que dependiendo del modelo esta colinealidad podría afectar su desempeño.

![Matriz de correlación de las variables climatológicas. Fuente: Elaboración propia](rasters/Correlation_full.png)


### Histogramas

Consecuentemente, queremos ver las distribuciones de las variables y comprobar si
tienen distribuciones normales o si por el contrario presentan alguna forma distinta,
de esta manera podemos escoger una estrategia de escalamiento de los datos.

![Histograma (distribución) de cada variable en los niveles de desnutrición aguda. Fuente: Elaboración propia](rasters/Histograms_full.png)


### Cajas y bigotes

Finalmente, visualizamos cajas y bigotes para visualizar de forma general la cantidad
de outliers de las diferentes variables y al mismo tiempo verificar si las distribuciones
entre observaciones de niños con o sin desnutrición son similares o difieren en cuartiles,
rango, etc.

![Gráfico de cajas y bigotes para cada variable climatológica en los niveles de desnutrición. Fuente: Elaboración Propia](rasters/Boxplots_full.png)


## Pre procesamiento

Seleccionamos el training y test set. En el caso del entrenamiento tomamos los años 2014 a X. Test sería el año siguiente a X.

```{r preprocess, results = FALSE}

# Training set

training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, 
                                 malnutrition_16, malnutrition_17, 
                                 malnutrition_18)) %>% 
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff) %>%
  mutate(malnutrition = factor(malnutrition))


# Test set

test_set <- malnutrition_19 %>%
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff) %>%
  mutate(malnutrition = factor(malnutrition))

```


## Cross validation - Hyperparameters Optimization

Utilizamos una búsqueda de valores aleatorios y dividimos 3 folds de validación.
Los hiperparámetros a configurar son: mtry, min_n y trees.

```{r crossval}
set.seed(1501)

#Train test split

data_train <- training_set
data_test  <- test_set

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = data_train) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

# Aplicar receta de preprocesamiento a los datos
malnutrition_preprocessed <-
  recipes::bake(
    rec_preprocessed, 
    new_data = data_train
  ) %>%  
  rsample::vfold_cv(v = 3, strata = "malnutrition", breaks = 5)

# Definir la fórmula del modelo
formula <- "malnutrition ~ ."

rf_spec <- rand_forest(
  mtry = tune(),
  min_n = tune(),
  trees = tune()
) %>%
  set_engine("randomForest") %>%
  set_mode("classification")

rf_params <- 
  dials::parameters(
    mtry(),
    min_n(),
    trees()
  ) %>%
  dials::finalize(data_train %>% select(-malnutrition))

rf_grid <- 
  dials::grid_random(
    rf_params, 
    size = 50
  )

knitr::kable(head(rf_grid))

rf_wf <- 
  workflows::workflow() %>%
  add_model(rf_spec) %>% 
  add_formula(malnutrition ~ .)

train_processed <- bake(rec_preprocessed,  new_data = data_train)
```

A partir de acá, se hace la búsqueda de hiperparámetros y el cross-validation.
 
```{r hypercross, eval = FALSE}
# Sintonización de hiperparámetros
rf_tuned <- tune::tune_grid(
  object = rf_wf,
  resamples = malnutrition_preprocessed,
  grid = rf_grid,
  metrics = yardstick::metric_set(accuracy, f_meas),
  control = tune::control_grid(verbose = TRUE)
)
```
 
 
### Muestra de hiperparámetros probados 
 
```{r hyperlist, eval = FALSE}

params_rf_ndvi <- rf_tuned %>%
  tune::show_best(metric = "f_meas") %>%
  dplyr::slice(1:20) %>%
  knitr::kable() %>%
  kable_styling("striped")

models_results<- collect_metrics(rf_tuned)

```

### 2014 para 2015

```{r 2014, echo=FALSE}
RF_2014 <- read_csv("models/RF/RF_cv_1.csv") %>%
  mutate(.config = gsub("Preprocessor1_", "", .config))
head(RF_2014, n = 30)
```


### 2014-2015 para 2016

```{r 2015, echo=FALSE}
RF_2015 <- read_csv("models/RF/RF_cv_2.csv") %>%
  mutate(.config = gsub("Preprocessor1_", "", .config))
head(RF_2015, n = 30)
```


### 2014-2016 para 2017

```{r 2016, echo=FALSE}
RF_2016 <- read_csv("models/RF/RF_cv_3.csv") %>%
  mutate(.config = gsub("Preprocessor1_", "", .config))
head(RF_2016, n = 30)
```


### 2014-2017 para 2018 

```{r 2017, echo=FALSE}
RF_2017 <- read_csv("models/RF/RF_cv_4.csv") %>%
  mutate(.config = gsub("Preprocessor1_", "", .config))
head(RF_2017, n = 30)
```


### 2014-2018 para 2019

```{r 2018, echo=FALSE}
RF_2018 <- read_csv("models/RF/RF_cv_5_R.csv") %>%
  mutate(.config = gsub("Preprocessor1_", "", .config))
head(RF_2018, n = 30)
```

## Evaluación out of sample

### 2014 para 2015

```{r eval1, eval = FALSE, echo = FALSE}

training_set <- data.frame(malnutrition_14) %>% 
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

test_set <- malnutrition_15 %>%
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)

rf_model_1 <- readRDS("models/RF/modelo_rf__NDVI_maxfmeas_1.rds")

rf_model <- rf_model_1 %>%
  fit(
    formula = malnutrition ~ ., 
    data = train_processed
  ) %>%
  predict(new_data = test_processed, type = "prob") %>%
  mutate(.pred_class = if_else(.pred_1 > 0.1, "1", "0")) %>%
  bind_cols(test_set)

# Calcular el accuracy
accuracy <- mean(rf_model$.pred_class == rf_model$malnutrition)

# Calcular el recall
true_positive <- sum(rf_model$.pred_class == "1" & rf_model$malnutrition == "1")
false_negative <- sum(rf_model$.pred_class == "0" & rf_model$malnutrition == "1")
recall <- true_positive / (true_positive + false_negative)
```


### Entrenamiento y métricas de evaluación 2014 -> 2015

```{r importance2014, echo = TRUE}

training_set <- data.frame(malnutrition_14) %>% 
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_15 %>%
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  update_role(HHID, new_role = "ID") %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)


rf_spec <- rand_forest(
  mtry = 3,
  min_n = 19,
  trees = 1305
) %>%
  set_engine("ranger", importance = 'impurity', regularization.factor = 0.5) %>%
  set_mode("classification")


rf_wf <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(rec_preprocessed)

rf_fit <- rf_wf %>%
  fit(data = training_set)

# Predicciones para el conjunto de entrenamiento
rf_training_pred <- 
  predict(rf_fit, training_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.2, "1", "0"))) %>%
  bind_cols(training_set %>% select(malnutrition))

rf_training_pred %>%                # training set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_training_pred %>%                # training set predictions
  accuracy(truth = malnutrition, .pred_class)

# Predicciones para el conjunto de prueba
rf_testing_pred <- 
  predict(rf_fit, test_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.1, "1", "0"))) %>%
  bind_cols(test_set %>% select(malnutrition))

rf_testing_pred %>%                   # test set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_testing_pred %>%                   # test set predictions
  accuracy(truth = malnutrition, .pred_class)

library(vip)

# Extraer el modelo ajustado del flujo de trabajo
rf_model <- pull_workflow_fit(rf_fit)

num_features <- ncol(training_set) - 1

# Generar el gráfico de importancia de variables
vip(rf_model, method = "model", num_features = num_features)

```
### Otras métricas
```{r}
# VPP (Valor Predictivo Positivo)
rf_training_pred %>%
  ppv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  ppv(truth = malnutrition, .pred_class)

# VPN (Valor Predictivo Negativo)
rf_training_pred %>%
  npv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  npv(truth = malnutrition, .pred_class)

# F1-score
rf_training_pred %>%
  f_meas(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  f_meas(truth = malnutrition, .pred_class)


# Matriz de confusión para el conjunto de entrenamiento
rf_training_conf_mat <- 
  rf_training_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_training_conf_mat)

# Matriz de confusión para el conjunto de prueba
rf_testing_conf_mat <- 
  rf_testing_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_testing_conf_mat)


```



```{r, echo = FALSE}
# Mostrar los resultados
cat("\nAccuracy: 0.5631324 \n")
cat("Recall: 0.6048944 \n")
```



### 2014-2015 para 2016

```{r eval2, eval = FALSE, echo = FALSE}

training_set <- data.frame(rbind(malnutrition_14, malnutrition_15) %>% 
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_16 %>%
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)


# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)

rf_model_1 <- readRDS("models/RF/modelo_rf__NDVI_maxfmeas_2.rds")

rf_model <- rf_model_1 %>%
  fit(
    formula = malnutrition ~ ., 
    data = train_processed
  ) %>%
  predict(new_data = test_processed, type = "prob") %>%
  mutate(.pred_class = if_else(.pred_1 > 0.1, "1", "0")) %>%
  bind_cols(test_set)

# Calcular el accuracy
accuracy <- mean(rf_model$.pred_class == rf_model$malnutrition)

# Calcular el recall
true_positive <- sum(rf_model$.pred_class == "1" & rf_model$malnutrition == "1")
false_negative <- sum(rf_model$.pred_class == "0" & rf_model$malnutrition == "1")
recall <- true_positive / (true_positive + false_negative)
```


### Entrenamiento y métricas de evaluación 2014 -> 2016

```{r importance2015, echo = TRUE}
training_set <- data.frame(rbind(malnutrition_14, malnutrition_15)) %>% 
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_16 %>%
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  update_role(HHID, new_role = "ID") %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)


rf_spec <- rand_forest(
  mtry = 3,
  min_n = 35,
  trees = 1353
) %>%
  set_engine("ranger", importance = 'impurity', regularization.factor = 0.5) %>%
  set_mode("classification")


rf_wf <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(rec_preprocessed)

rf_fit <- rf_wf %>%
  fit(data = training_set)

# Predicciones para el conjunto de entrenamiento
rf_training_pred <- 
  predict(rf_fit, training_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.2, "1", "0"))) %>%
  bind_cols(training_set %>% select(malnutrition))

rf_training_pred %>%                # training set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_training_pred %>%                # training set predictions
  accuracy(truth = malnutrition, .pred_class)

# Predicciones para el conjunto de prueba
rf_testing_pred <- 
  predict(rf_fit, test_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.1, "1", "0"))) %>%
  bind_cols(test_set %>% select(malnutrition))

rf_testing_pred %>%                   # test set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_testing_pred %>%                   # test set predictions
  accuracy(truth = malnutrition, .pred_class)

library(vip)

# Extraer el modelo ajustado del flujo de trabajo
rf_model <- pull_workflow_fit(rf_fit)

num_features <- ncol(training_set) - 1

# Generar el gráfico de importancia de variables
vip(rf_model, method = "model", num_features = num_features)
```
### Otras métricas
```{r}
# VPP (Valor Predictivo Positivo)
rf_training_pred %>%
  ppv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  ppv(truth = malnutrition, .pred_class)

# VPN (Valor Predictivo Negativo)
rf_training_pred %>%
  npv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  npv(truth = malnutrition, .pred_class)

# F1-score
rf_training_pred %>%
  f_meas(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  f_meas(truth = malnutrition, .pred_class)


# Matriz de confusión para el conjunto de entrenamiento
rf_training_conf_mat <- 
  rf_training_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_training_conf_mat)

# Matriz de confusión para el conjunto de prueba
rf_testing_conf_mat <- 
  rf_testing_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_testing_conf_mat)
```




```{r, echo = FALSE}
# Mostrar los resultados
cat("\nAccuracy: 0.5893256 \n")
cat("Recall: 0.56317016 \n")
```



### 2014-2016 para 2017

```{r eval3, eval = FALSE, echo = FALSE}

training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, malnutrition_16)) %>% 
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

test_set <- malnutrition_17 %>%
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)

rf_model_1 <- readRDS("models/RF/modelo_rf__NDVI_maxfmeas_3.rds")

rf_model <- rf_model_1 %>%
  fit(
    formula = malnutrition ~ ., 
    data = train_processed
  ) %>%
  predict(new_data = test_processed, type = "prob") %>%
  mutate(.pred_class = if_else(.pred_1 > 0.1, "1", "0")) %>%
  bind_cols(test_set)

# Calcular el accuracy
accuracy <- mean(rf_model$.pred_class == rf_model$malnutrition)

# Calcular el recall
true_positive <- sum(rf_model$.pred_class == "1" & rf_model$malnutrition == "1")
false_negative <- sum(rf_model$.pred_class == "0" & rf_model$malnutrition == "1")
recall <- true_positive / (true_positive + false_negative)
```


### Entrenamiento y métricas de evaluación 2014 -> 2017

```{r importance2016, echo = TRUE}
training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, malnutrition_16)) %>% 
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_17 %>%
  dplyr::transmute(
    area_residence, region,
    
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    NDVI_high_count, NDVI_low_count, NDVI_range,
    
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff,
    pr_high_count, pr_low_count, pr_range,
    
    
    tmax_range, tmin_range, TGAP = TMAX - TMIN) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  update_role(HHID, new_role = "ID") %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)


rf_spec <- rand_forest(
  mtry = 1,
  min_n = 37,
  trees = 1617
) %>%
  set_engine("ranger", importance = 'impurity', regularization.factor = 0.5) %>%
  set_mode("classification")


rf_wf <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(rec_preprocessed)

rf_fit <- rf_wf %>%
  fit(data = training_set)

# Predicciones para el conjunto de entrenamiento
rf_training_pred <- 
  predict(rf_fit, training_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.2, "1", "0"))) %>%
  bind_cols(training_set %>% select(malnutrition))

rf_training_pred %>%                # training set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_training_pred %>%                # training set predictions
  accuracy(truth = malnutrition, .pred_class)

# Predicciones para el conjunto de prueba
rf_testing_pred <- 
  predict(rf_fit, test_set, type = "prob") %>%
  mutate(.pred_class =  as.factor(ifelse(.pred_1 > 0.09, "1", "0"))) %>%
  bind_cols(test_set %>% select(malnutrition))

rf_testing_pred %>%                   # test set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_testing_pred %>%                   # test set predictions
  accuracy(truth = malnutrition, .pred_class)

library(vip)

# Extraer el modelo ajustado del flujo de trabajo
rf_model <- pull_workflow_fit(rf_fit)

num_features <- ncol(training_set) - 1

# Generar el gráfico de importancia de variables
vip(rf_model, method = "model", num_features = num_features)
```


### Otras métricas
```{r}
# VPP (Valor Predictivo Positivo)
rf_training_pred %>%
  ppv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  ppv(truth = malnutrition, .pred_class)

# VPN (Valor Predictivo Negativo)
rf_training_pred %>%
  npv(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  npv(truth = malnutrition, .pred_class)

# F1-score
rf_training_pred %>%
  f_meas(truth = malnutrition, .pred_class)

rf_testing_pred %>%
  f_meas(truth = malnutrition, .pred_class)


# Matriz de confusión para el conjunto de entrenamiento
rf_training_conf_mat <- 
  rf_training_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_training_conf_mat)

# Matriz de confusión para el conjunto de prueba
rf_testing_conf_mat <- 
  rf_testing_pred %>%
  conf_mat(truth = malnutrition, estimate = .pred_class)

print(rf_testing_conf_mat)
```


```{r, echo = FALSE}
# Mostrar los resultados
cat("\nAccuracy: 0.62277 \n")
cat("Recall: 0.4382124 \n")
```



### 2014-2017 para 2018

```{r eval4, eval = FALSE, echo = FALSE}

training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, 
                                 malnutrition_16, malnutrition_17)) %>% 
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

test_set <- malnutrition_18 %>%
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))


# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)

rf_model_1 <- readRDS("models/RF/modelo_rf__NDVI_maxfmeas_4.rds")

rf_model <- rf_model_1 %>%
  fit(
    formula = malnutrition ~ ., 
    data = train_processed
  ) %>%
  predict(new_data = test_processed, type = "prob") %>%
  mutate(.pred_class = if_else(.pred_1 > 0.1, "1", "0")) %>%
  bind_cols(test_set)

# Calcular el accuracy
accuracy <- mean(rf_model$.pred_class == rf_model$malnutrition)

# Calcular el recall
true_positive <- sum(rf_model$.pred_class == "1" & rf_model$malnutrition == "1")
false_negative <- sum(rf_model$.pred_class == "0" & rf_model$malnutrition == "1")
recall <- true_positive / (true_positive + false_negative)
```

```{r importance2017, eval = FALSE}
training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, malnutrition_16, malnutrition_17)) %>% 
  dplyr::transmute(
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_18 %>%
  dplyr::select(
    HHID, malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  update_role(HHID, new_role = "ID") %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)


rf_spec <- rand_forest(
  mtry = 1,
  min_n = 38,
  trees = 80
) %>%
  set_engine("ranger", importance = 'impurity', regularization.factor = 0.5) %>%
  set_mode("classification")


rf_wf <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(rec_preprocessed)

rf_fit <- rf_wf %>%
  fit(data = training_set)

rf_training_pred <- 
  predict(rf_fit, training_set) %>% 
  bind_cols(predict(rf_fit, training_set, type = "prob")) %>% 
  # Add the true outcome data back in
  bind_cols(training_set %>% 
              select(malnutrition))

rf_training_pred %>%                # training set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_training_pred %>%                # training set predictions
  accuracy(truth = malnutrition, .pred_class)

rf_testing_pred <- 
  predict(rf_fit, test_set) %>% 
  bind_cols(predict(rf_fit, test_set, type = "prob")) %>% 
  bind_cols(test_set %>% select(malnutrition))

rf_testing_pred %>%                   # test set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_testing_pred %>%                   # test set predictions
  accuracy(truth = malnutrition, .pred_class)

library(vip)

# Extraer el modelo ajustado del flujo de trabajo
rf_model <- pull_workflow_fit(rf_fit)

# Generar el gráfico de importancia de variables
vip(rf_model, method = "model")
```

```{r, echo = FALSE}
# Mostrar los resultados
cat("\nAccuracy: 0.5058414 \n")
cat("Recall: 0.68280614 \n")
```




### 2014-2018 para 2019

```{r eval5, eval = FALSE, echo = FALSE}

training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, 
                                 malnutrition_16, malnutrition_17,
                                 malnutrition_18)) %>% 
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))

test_set <- malnutrition_19 %>%
  dplyr::select(
    malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition))


# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)

rf_model_1 <- readRDS("models/RF/modelo_rf__NDVI_maxfmeas_5.rds")

rf_model <- rf_model_1 %>%
  fit(
    formula = malnutrition ~ ., 
    data = train_processed
  ) %>%
  predict(new_data = test_processed, type = "prob") %>%
  mutate(.pred_class = if_else(.pred_1 > 0.1, "1", "0")) %>%
  bind_cols(test_set)

# Calcular el accuracy
accuracy <- mean(rf_model$.pred_class == rf_model$malnutrition)

# Calcular el recall
true_positive <- sum(rf_model$.pred_class == "1" & rf_model$malnutrition == "1")
false_negative <- sum(rf_model$.pred_class == "0" & rf_model$malnutrition == "1")
recall <- true_positive / (true_positive + false_negative)
```

```{r importance2018, eval = FALSE}
training_set <- data.frame(rbind(malnutrition_14, malnutrition_15, malnutrition_16, 
                                 malnutrition_17, malnutrition_18)) %>% 
  dplyr::transmute(
    HHID,malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition), HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

test_set <- malnutrition_19 %>%
  dplyr::select(
    HHID, malnutrition, NDVI_mean, NDVI_sd, NDVI_median, NDVI_IQR, 
    NDVI_last_months, NDVI_first_months, NDVI_seasonal_diff, 
    pr_mean, pr_sd, pr_median, pr_IQR, pr_last_months, 
    pr_first_months, pr_seasonal_diff, TGAP) %>%
  mutate(malnutrition = factor(malnutrition) , HHID = as.numeric(HHID))# %>%
#  distinct(HHID, .keep_all = TRUE)

# Crear un objeto recipe para preprocesamiento
rec <- recipe(malnutrition ~ ., data = training_set) %>%
  update_role(HHID, new_role = "ID") %>%
  step_center(all_numeric()) %>%
  step_scale(all_numeric())

# Preprocesamiento
rec_preprocessed <- prep(rec)

train_processed  <- bake(rec_preprocessed, new_data = training_set)

test_processed  <- bake(rec_preprocessed, new_data = test_set)


rf_spec <- rand_forest(
  mtry = 1,
  min_n = 27,
  trees = 1538
) %>%
  set_engine("ranger", importance = 'impurity', regularization.factor = 0.5) %>%
  set_mode("classification")


rf_wf <- 
  workflow() %>% 
  add_model(rf_spec) %>% 
  add_recipe(rec_preprocessed)

rf_fit <- rf_wf %>%
  fit(data = training_set)

rf_training_pred <- 
  predict(rf_fit, training_set) %>% 
  bind_cols(predict(rf_fit, training_set, type = "prob")) %>% 
  # Add the true outcome data back in
  bind_cols(training_set %>% 
              select(malnutrition))

rf_training_pred %>%                # training set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_training_pred %>%                # training set predictions
  accuracy(truth = malnutrition, .pred_class)

rf_testing_pred <- 
  predict(rf_fit, test_set) %>% 
  bind_cols(predict(rf_fit, test_set, type = "prob")) %>% 
  bind_cols(test_set %>% select(malnutrition))

rf_testing_pred %>%                   # test set predictions
  roc_auc(truth = malnutrition, .pred_1)

rf_testing_pred %>%                   # test set predictions
  accuracy(truth = malnutrition, .pred_class)

library(vip)

# Extraer el modelo ajustado del flujo de trabajo
rf_model <- pull_workflow_fit(rf_fit)

# Generar el gráfico de importancia de variables
vip(rf_model, method = "model")
```

```{r, echo = FALSE}
# Mostrar los resultados
cat("\nAccuracy: 0.5460739 \n")
cat("Recall: 0.5483613 \n")
```


![Accuracy y Recall en ventanas de tiempo del 2014 al 2019. Fuente: Elaboración Propia](rasters/acc_recall.png)
