---
title: "Modelo predictivo de desnutrición aguda a partir de factores medioambientales"
author: "Luis Revilla"
date: "2022-12-23"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data geoespacial

Utilizando Google Cloud CLI y el paquete de R llamado "rgee" para utilizar Google Earth Engine se obtuvo la data del año 2019, por meses, de la precipitación y la temperatura del Perú.

```{r Google Earth Engine, echo = FALSE}
library(raster)
library(terra)
library(ggplot2)

precipitation <- rast("rasters/pp_2019.tif")
temp_max <- rast("rasters/temp_max_2019.tif")
temp_min <- rast("rasters/temp_min_2019.tif")
```

## Precipitación


```{r precipitation, echo=FALSE}

plot(precipitation, main="Precipitation IDAHO Terraclimate - Peru 2019", xlab="Longitude", ylab="Latitude")


```

## Temperatura Máxima

```{r temp_max, echo=FALSE}
plot(temp_max, main="Maximum temperature IDAHO Terraclimate - Peru 2019", xlab="Longitude", ylab="Latitude", )
```

## Temperatura Mínima

```{r temp_min, echo=FALSE}
plot(temp_min, main="Minimum temperature IDAHO Terraclimate - Peru 2019", xlab="Longitude", ylab="Latitude", )
```

## Feature engineering

### Carga de las librerías para manipulación de la data descargada de ENDES

```{r, echo = FALSE}
library(tidyverse)
library(haven)
library(fs)
library(readr)
library(dplyr)
library(purrr)
library(ggplot2)
```


## Obtención de los datasets a nivel de niño y hogar para los años 2014-2019

```{r, echo = FALSE}
path_2014 <- path("dataset/2014/malnutrition_2014.csv")
malnutrition_2014 <- read_csv(path_2014) %>%
  mutate(HHID = as.character(HHID)) # En este año el HHID era numérico

path_2015 <- path("dataset/2015/malnutrition_2015.csv")
malnutrition_2015 <- read_csv(path_2015)

path_2016 <- path("dataset/2016/malnutrition_2016.csv")
malnutrition_2016 <- read_csv(path_2016)

path_2017 <- path("dataset/2017/malnutrition_2017.csv")
malnutrition_2017 <- read_csv(path_2017)

path_2018 <- path("dataset/2018/malnutrition_2018.csv")
malnutrition_2018 <- read_csv(path_2018)

path_2019 <- path("dataset/2019/malnutrition_2019.csv")
malnutrition_2019 <- read_csv(path_2019)

```

## Feature engineering de los dataset climáticos (IDAHO) (radio de 5 km)

```{r, echo = FALSE}
dataset <- load("variables.RData") 

# Para cada dataset climatológico del 2014, cambiar el identificador

lista_ndvi[[1]] <- lista_ndvi[[1]] %>%
  mutate(HHID = as.character(HHID))

lista_pp[[1]] <- lista_pp[[1]] %>%
  mutate(HHID = as.character(HHID))

lista_savi[[1]] <- lista_savi[[1]] %>%
  mutate(HHID = as.character(HHID))

lista_tmax[[1]] <- lista_tmax[[1]] %>%
  mutate(HHID = as.character(HHID))

lista_tmin[[1]] <- lista_tmin[[1]] %>%
  mutate(HHID = as.character(HHID))

# Creamos una lista incluyendo todos los dataset a nivel de niño y hogar (ENDES)

malnutrition <- list("2014" = malnutrition_2014, "2015" = malnutrition_2015, "2016" = malnutrition_2016, "2017" = malnutrition_2017, "2018" = malnutrition_2018, "2019" = malnutrition_2019) %>% 
  bind_rows(.id = "year") %>%
  mutate(direct = paste(as.character(longitudx), as.character(latitudy)))

# Modificamos los nombres de cada dataset climatológico para que coincida
# con los años del ENDES (radio de 5 km)

names(lista_ndvi)= c("2014", "2015", "2016", "2017", "2018", "2019")
names(lista_pp) = c("2014", "2015", "2016", "2017", "2018", "2019")
names(lista_savi) = c("2014", "2015", "2016", "2017", "2018", "2019")
names(lista_tmax) = c("2014", "2015", "2016", "2017", "2018", "2019")
names(lista_tmin) = c("2014", "2015", "2016", "2017", "2018", "2019")

lista_ndvi <- lista_ndvi %>%
  bind_rows(.id = "year")

lista_pp <- lista_pp %>%
  bind_rows(.id = "year")

lista_savi <- lista_savi %>%
  bind_rows(.id = "year")

lista_tmax <- lista_tmax %>%
  bind_rows(.id = "year")

lista_tmin <- lista_tmin %>%
  bind_rows(.id = "year")


```

## Merge de los datasets (ENDES y IDAHO) para variables climatológicas y de niño

```{r}
lista_full <- lista_ndvi %>%
  inner_join(lista_pp, by = c("year", "HHID")) %>%
  inner_join(lista_savi, by = c("year", "HHID")) %>%
  inner_join(lista_tmax, by = c("year", "HHID")) %>%
  inner_join(lista_tmin, by = c("year", "HHID"))

HHID_XD <- lista_full %>%
  select(HHID)

coordinates <- malnutrition %>%
  inner_join(HHID_XD, by = "HHID") %>%
  transmute(HHID, direct = paste(as.character(longitudx), as.character(latitudy)))

lista_full <- lista_full %>%
  inner_join(coordinates, by = "HHID")

malnutrition <- malnutrition %>%
  inner_join(lista_full, by = c("direct","year"))

malnutrition_path <- paste("malnutrition_final.csv", sep = "")

doc_path <- ("dataset")

write_csv(malnutrition, path(doc_path,malnutrition_path))  
```

## Data exploration

```{r, echo = FALSE}
malnutrition_final <- read_csv("dataset/malnutrition_final.csv") 

ggplot() + geom_histogram(data = malnutrition_final, aes(x = malnutrition_final$malnutrition), bins = 2, fill = "darkgreen", col = "black") +

labs(x = "Children with acute malnutrition", y = "Frequency") +

scale_x_continuous(breaks = seq(from = 0, to = 1, by = 1)) + theme_bw()
```


```{r}
ggplot() + geom_histogram(data = malnutrition_final, aes(x = malnutrition_final$region), bins = 25, fill = "darkgreen", col = "black") +

labs(x = "Region where children belong to", y = "Frequency") +

scale_x_continuous(breaks = seq(from = 0, to = 25, by = 1)) + theme_bw()
```
```{r}
ggplot() + geom_histogram(data = malnutrition_final, aes(x = malnutrition_final$area_residence), bins = 2, fill = "darkgreen", col = "black") +

labs(x = "Area of residence", y = "Frequency") +

scale_x_continuous(breaks = seq(from = 0, to = 2, by = 1)) + theme_bw()
```
```{r}
library(raster)

library(scales)  ## for the alpha function below

pe <- getData("GADM", country = "PER", level = 1,
             path = "dataset/")

plot(pe, border = "gray", lwd = 0.5)
points(malnutrition_final$longitudx, malnutrition_final$latitudy, pch = 16,
       col = alpha("red", 0.01))
```
```{r}
coordinates(malnutrition_final) <- ~longitudx+latitudy
```

```{r}

malnutrition_final <- read_csv("dataset/malnutrition_final.csv") 

## 2014

malnutrition_14 <- malnutrition_final %>%
  filter(year==2014) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.0_NDVI"):
	                          which(names(malnutrition_final)=="mean.11_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.0_EVI"):
	                          which(names(malnutrition_final)=="mean.11_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201401_pr"):
	                          which(names(malnutrition_final)=="mean.201412_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201401_tmmx"):
	                          which(names(malnutrition_final)=="mean.201412_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201401_tmmn"):
	                          which(names(malnutrition_final)=="mean.201412_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)

## 2015

malnutrition_15 <- malnutrition_final %>%
  filter(year==2015) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.12_NDVI"):
	                          which(names(malnutrition_final)=="mean.23_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.12_EVI"):
	                          which(names(malnutrition_final)=="mean.23_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201501_pr"):
	                          which(names(malnutrition_final)=="mean.201512_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201501_tmmx"):
	                          which(names(malnutrition_final)=="mean.201512_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201501_tmmn"):
	                          which(names(malnutrition_final)=="mean.201512_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)


## 2016

malnutrition_16 <- malnutrition_final %>%
  filter(year==2016) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.24_NDVI"):
	                          which(names(malnutrition_final)=="mean.35_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.24_EVI"):
	                          which(names(malnutrition_final)=="mean.35_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201601_pr"):
	                          which(names(malnutrition_final)=="mean.201612_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201601_tmmx"):
	                          which(names(malnutrition_final)=="mean.201612_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201601_tmmn"):
	                          which(names(malnutrition_final)=="mean.201612_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)

## 2017
malnutrition_17 <- malnutrition_final %>%
  filter(year==2017) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.36_NDVI"):
	                          which(names(malnutrition_final)=="mean.47_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.36_EVI"):
	                          which(names(malnutrition_final)=="mean.47_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201701_pr"):
	                          which(names(malnutrition_final)=="mean.201712_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201701_tmmx"):
	                          which(names(malnutrition_final)=="mean.201712_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201701_tmmn"):
	                          which(names(malnutrition_final)=="mean.201712_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)


## 2018
malnutrition_18 <- malnutrition_final %>%
  filter(year==2018) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.48_NDVI"):
	                          which(names(malnutrition_final)=="mean.59_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.48_EVI"):
	                          which(names(malnutrition_final)=="mean.59_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201801_pr"):
	                          which(names(malnutrition_final)=="mean.201812_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201801_tmmx"):
	                          which(names(malnutrition_final)=="mean.201812_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201801_tmmn"):
	                          which(names(malnutrition_final)=="mean.201812_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)


## 2019
malnutrition_19 <- malnutrition_final %>%
  filter(year==2019) %>%
	mutate(NDVI = rowMeans(.[,which(names(malnutrition_final)=="mean.60_NDVI"):
	                          which(names(malnutrition_final)=="mean.71_NDVI")]),
	       
	       SAVI = rowMeans(.[,which(names(malnutrition_final)=="mean.60_EVI"):
	                          which(names(malnutrition_final)=="mean.71_EVI")]),
	       
	       PP = rowSums(.[,which(names(malnutrition_final)=="mean.201901_pr"):
	                          which(names(malnutrition_final)=="mean.201912_pr")]),
	       
	       TMAX = rowMeans(.[,which(names(malnutrition_final)=="mean.201901_tmmx"):
	                          which(names(malnutrition_final)=="mean.201912_tmmx")])/10,
	       
	       TMIN = rowMeans(.[,which(names(malnutrition_final)=="mean.201901_tmmn"):
	                          which(names(malnutrition_final)=="mean.201912_tmmn")])/10)%>%
  mutate(
    NDVI = case_when(
		NDVI >=0 & NDVI <=0.3 ~ 1, 
		NDVI > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI = case_when(
		SAVI >=0 & SAVI <=0.3 ~ 1, 
		SAVI > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP = case_when(
    PP <= 500 ~ 0,
    PP < 500 & PP <= 1000 ~ 1,
		PP > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP = TMAX - TMIN) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI, SAVI, PP, TGAP, TMAX, TMIN)

```



```{r}
malnutrition_final <- read_csv("dataset/malnutrition_final.csv") 

## 2014

malnutrition <- malnutrition_final %>%
	mutate(NDVI_14 = rowMeans(.[,which(names(malnutrition_final)=="mean.0_NDVI"):
	                          which(names(malnutrition_final)=="mean.11_NDVI")]),
	       
	       SAVI_14 = rowMeans(.[,which(names(malnutrition_final)=="mean.0_EVI"):
	                          which(names(malnutrition_final)=="mean.11_EVI")]),
	       
	       PP_14 = rowSums(.[,which(names(malnutrition_final)=="mean.201401_pr"):
	                          which(names(malnutrition_final)=="mean.201412_pr")]),
	       
	       TMAX_14 = rowMeans(.[,which(names(malnutrition_final)=="mean.201401_tmmx"):
	                          which(names(malnutrition_final)=="mean.201412_tmmx")])/10,
	       
	       TMIN_14 = rowMeans(.[,which(names(malnutrition_final)=="mean.201401_tmmn"):
	                          which(names(malnutrition_final)=="mean.201412_tmmn")])/10,
	       
	       NDVI_15 = rowMeans(.[,which(names(malnutrition_final)=="mean.12_NDVI"):
	                          which(names(malnutrition_final)=="mean.23_NDVI")]),
	       
	       SAVI_15 = rowMeans(.[,which(names(malnutrition_final)=="mean.12_EVI"):
	                          which(names(malnutrition_final)=="mean.23_EVI")]),
	       
	       PP_15 = rowSums(.[,which(names(malnutrition_final)=="mean.201501_pr"):
	                          which(names(malnutrition_final)=="mean.201512_pr")]),
	       
	       TMAX_15 = rowMeans(.[,which(names(malnutrition_final)=="mean.201501_tmmx"):
	                          which(names(malnutrition_final)=="mean.201512_tmmx")])/10,
	       
	       TMIN_15 = rowMeans(.[,which(names(malnutrition_final)=="mean.201501_tmmn"):
	                          which(names(malnutrition_final)=="mean.201512_tmmn")])/10,
	       
	       NDVI_16 = rowMeans(.[,which(names(malnutrition_final)=="mean.24_NDVI"):
	                          which(names(malnutrition_final)=="mean.35_NDVI")]),
	       
	       SAVI_16 = rowMeans(.[,which(names(malnutrition_final)=="mean.24_EVI"):
	                          which(names(malnutrition_final)=="mean.35_EVI")]),
	       
	       PP_16 = rowSums(.[,which(names(malnutrition_final)=="mean.201601_pr"):
	                          which(names(malnutrition_final)=="mean.201612_pr")]),
	       
	       TMAX_16 = rowMeans(.[,which(names(malnutrition_final)=="mean.201601_tmmx"):
	                          which(names(malnutrition_final)=="mean.201612_tmmx")])/10,
	       
	       TMIN_16 = rowMeans(.[,which(names(malnutrition_final)=="mean.201601_tmmn"):
	                          which(names(malnutrition_final)=="mean.201612_tmmn")])/10,
	       
	       NDVI_17 = rowMeans(.[,which(names(malnutrition_final)=="mean.36_NDVI"):
	                          which(names(malnutrition_final)=="mean.47_NDVI")]),
	       
	       SAVI_17 = rowMeans(.[,which(names(malnutrition_final)=="mean.36_EVI"):
	                          which(names(malnutrition_final)=="mean.47_EVI")]),
	       
	       PP_17 = rowSums(.[,which(names(malnutrition_final)=="mean.201701_pr"):
	                          which(names(malnutrition_final)=="mean.201712_pr")]),
	       
	       TMAX_17 = rowMeans(.[,which(names(malnutrition_final)=="mean.201701_tmmx"):
	                          which(names(malnutrition_final)=="mean.201712_tmmx")])/10,
	       
	       TMIN_17 = rowMeans(.[,which(names(malnutrition_final)=="mean.201701_tmmn"):
	                          which(names(malnutrition_final)=="mean.201712_tmmn")])/10,
	       
	       NDVI_18 = rowMeans(.[,which(names(malnutrition_final)=="mean.48_NDVI"):
	                          which(names(malnutrition_final)=="mean.59_NDVI")]),
	       
	       SAVI_18 = rowMeans(.[,which(names(malnutrition_final)=="mean.48_EVI"):
	                          which(names(malnutrition_final)=="mean.59_EVI")]),
	       
	       PP_18 = rowSums(.[,which(names(malnutrition_final)=="mean.201801_pr"):
	                          which(names(malnutrition_final)=="mean.201812_pr")]),
	       
	       TMAX_18 = rowMeans(.[,which(names(malnutrition_final)=="mean.201801_tmmx"):
	                          which(names(malnutrition_final)=="mean.201812_tmmx")])/10,
	       
	       TMIN_18 = rowMeans(.[,which(names(malnutrition_final)=="mean.201801_tmmn"):
	                          which(names(malnutrition_final)=="mean.201812_tmmn")])/10,
	       
	       NDVI_19 = rowMeans(.[,which(names(malnutrition_final)=="mean.60_NDVI"):
	                          which(names(malnutrition_final)=="mean.71_NDVI")]),
	       
	       SAVI_19 = rowMeans(.[,which(names(malnutrition_final)=="mean.60_EVI"):
	                          which(names(malnutrition_final)=="mean.71_EVI")]),
	       
	       PP_19 = rowSums(.[,which(names(malnutrition_final)=="mean.201901_pr"):
	                          which(names(malnutrition_final)=="mean.201912_pr")]),
	       
	       TMAX_19 = rowMeans(.[,which(names(malnutrition_final)=="mean.201901_tmmx"):
	                          which(names(malnutrition_final)=="mean.201912_tmmx")])/10,
	       
	       TMIN_19 = rowMeans(.[,which(names(malnutrition_final)=="mean.201901_tmmn"):
	                          which(names(malnutrition_final)=="mean.201912_tmmn")])/10)%>%
  
  
  mutate(
    NDVI_14 = case_when(
		NDVI_14 >=0 & NDVI_14 <=0.3 ~ 1, 
		NDVI_14 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_14 = case_when(
		SAVI_14 >=0 & SAVI_14 <=0.3 ~ 1, 
		SAVI_14 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_14 = case_when(
    PP_14 <= 500 ~ 0,
    PP_14 < 500 & PP_14 <= 1000 ~ 1,
		PP_14 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_14 = TMAX_14 - TMIN_14,
		
		NDVI_15 = case_when(
		NDVI_15 >=0 & NDVI_15 <=0.3 ~ 1, 
		NDVI_15 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_15 = case_when(
		SAVI_15 >=0 & SAVI_15 <=0.3 ~ 1, 
		SAVI_15 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_15 = case_when(
    PP_15 <= 500 ~ 0,
    PP_15 < 500 & PP_15 <= 1000 ~ 1,
		PP_15 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_15 = TMAX_15 - TMIN_15,
		
		NDVI_16 = case_when(
		NDVI_16 >=0 & NDVI_16 <=0.3 ~ 1, 
		NDVI_16 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_16 = case_when(
		SAVI_16 >=0 & SAVI_16 <=0.3 ~ 1, 
		SAVI_16 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_16 = case_when(
    PP_16 <= 500 ~ 0,
    PP_16 < 500 & PP_16 <= 1000 ~ 1,
		PP_16 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_16 = TMAX_16 - TMIN_16,
		
		NDVI_17 = case_when(
		NDVI_17 >=0 & NDVI_17 <=0.3 ~ 1, 
		NDVI_17 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_17 = case_when(
		SAVI_17 >=0 & SAVI_17 <=0.3 ~ 1, 
		SAVI_17 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_17 = case_when(
    PP_17 <= 500 ~ 0,
    PP_17 < 500 & PP_17 <= 1000 ~ 1,
		PP_17 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_17 = TMAX_17 - TMIN_17,
		
		NDVI_18 = case_when(
		NDVI_18 >=0 & NDVI_18 <=0.3 ~ 1, 
		NDVI_18 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_18 = case_when(
		SAVI_18 >=0 & SAVI_18 <=0.3 ~ 1, 
		SAVI_18 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_18 = case_when(
    PP_18 <= 500 ~ 0,
    PP_18 < 500 & PP_18 <= 1000 ~ 1,
		PP_18 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_18 = TMAX_18 - TMIN_18,
		
		NDVI_19 = case_when(
		NDVI_19 >=0 & NDVI_19 <=0.3 ~ 1, 
		NDVI_19 > 0.3 ~ 2,
		TRUE ~ 0),
		
		SAVI_19 = case_when(
		SAVI_19 >=0 & SAVI_19 <=0.3 ~ 1, 
		SAVI_19 > 0.3 ~ 2,
		TRUE ~ 0), 
		
		PP_19 = case_when(
    PP_19 <= 500 ~ 0,
    PP_19 < 500 & PP_19 <= 1000 ~ 1,
		PP_19 > 1000  ~ 2, 
		TRUE ~ 3), 
		
		TGAP_19 = TMAX_19 - TMIN_19) %>% 
  
  transmute(year, HHID = HHID.x, malnutrition, longitudx, latitudy, area_residence, region, 
          weight, height, age, order, NDVI_14, NDVI_15, NDVI_16, NDVI_17, NDVI_18, NDVI_19, SAVI_14, SAVI_15, SAVI_16, SAVI_17, SAVI_18, SAVI_19, 
          PP_14, PP_15, PP_16, PP_17, PP_18, PP_19, TGAP_14, TGAP_15, TGAP_16, TGAP_17, TGAP_18, TGAP_19, TMAX_14, TMAX_15, TMAX_16, TMAX_17,
          TMAX_18, TMAX_19, TMIN_14, TMIN_15, TMIN_16, TMIN_17, TMIN_18, TMIN_19)
```

```{r}

write_csv(malnutrition, path(doc_path,malnutrition_path))  

malnutrition %>%
  group_by(year) %>%
  count(malnutrition)
```

```{r}
# Load data and split into training and testing datasets
data <- read.csv("dataset/malnutrition_final.csv") %>%
  select(-HHID)
train_indices <- sample(nrow(data), 0.9 * nrow(data))
train_data <- data[train_indices, ]
test_data <- data[-train_indices, ]

# Fit logistic regression model to training data
model <- glm(malnutrition ~ ., data = train_data, family = "binomial")

# Predict malnutrition using test data
predictions <- predict(model, newdata = test_data, type = "response")
predicted_classes <- ifelse(predictions > 0.5, 1, 0)

# Evaluate model performance using confusion matrix and other metrics
confusion_matrix <- table(test_data$malnutrition, predicted_classes)
accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
precision <- diag(confusion_matrix) / colSums(confusion_matrix)
recall <- diag(confusion_matrix) / rowSums(confusion_matrix)
```
```{r}
library(reshape2)

confusion_matrix <- table(test_data$malnutrition, predicted_classes)

confusion_matrix <- matrix(c(confusion_matrix[1,]/sum(confusion_matrix[1,]), 
                          confusion_matrix[2,]/sum(confusion_matrix[2,])), nrow=2,
                          dimnames = list(c("Not Malnourished", "Malnourished"), c("Not Malnourished", "Malnourished")))
  

conf_mat_plot <- ggplot(data = melt(confusion_matrix), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "steelblue") +
  labs(x = "Predicted Class", y = "Actual Class", fill = "Accuracy") +
  theme_minimal()
print(conf_mat_plot)

```


